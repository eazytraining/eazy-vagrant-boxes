# CentOS Stream 9 Kickstart - Version simplifiée pour debug

# Installation mode
install
text
cdrom

# Langue et clavier
lang en_US.UTF-8
keyboard us

# Configuration réseau - version simplifiée
network --bootproto=dhcp --onboot=yes --activate

# Mots de passe
rootpw --plaintext vagrant

# Utilisateur vagrant
user --name=vagrant --groups=wheel --plaintext --password=vagrant

# Fuseau horaire
timezone UTC

# Partitionnement automatique simple
zerombr
clearpart --all --initlabel
autopart

# Bootloader
bootloader --location=mbr

# Pas de X11
skipx

# Firewall - autoriser SSH
firewall --enabled --ssh

# SELinux en mode permissif pour éviter les problèmes
selinux --permissive

# Services
services --enabled=sshd,NetworkManager

# Packages minimaux
%packages --nobase --excludedocs
@core
openssh-server
sudo
wget
curl
-*firmware*
%end

# Post-installation
%post --log=/var/log/ks-post.log

# Configuration sudo pour vagrant
echo "vagrant ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/vagrant
chmod 440 /etc/sudoers.d/vagrant

# Configuration SSH
echo "UseDNS no" >> /etc/ssh/sshd_config
echo "GSSAPIAuthentication no" >> /etc/ssh/sshd_config

# S'assurer que SSH démarre
systemctl enable sshd

# Log pour debug
echo "Kickstart post-install completed at $(date)" >> /var/log/ks-post.log
echo "SSH service status:" >> /var/log/ks-post.log
systemctl status sshd >> /var/log/ks-post.log 2>&1

%end

# Redémarrage automatique
reboot --eject